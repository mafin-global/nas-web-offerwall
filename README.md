# 📖 NAS Web 오퍼월 연동 가이드

Web 오퍼월은 매체의 Web 사이트에서 오퍼월을 제공하기 위한 기능입니다.

Web 오퍼월은 `오퍼월 SDK`에서 제공하는 모든 광고가 제공되지 않으며, Web 에서 참여 할 수 있는 광고만 제공됩니다.

> iOS, 안드로이드 App 에서 오퍼월을 제공하시려면, [오퍼월 SDK 연동 가이드](https://github.com/mafin-global/nas-offerwall) 문서를 확인해주시기 바랍니다.

## 목차
- [👤️⠀개발자 등록](#%EF%B8%8F-개발자-등록)
- [🎲⠀매체 등록](#-매체-등록)
  - [적립금 관리 서버](#적립금-관리-서버)
  - [리워드 금액 단위](#리워드-금액-단위)
  - [리워드 금액 비율](#리워드-금액-비율)
  - [콜백 URL 등록](#콜백-url-등록)
- [🚀⠀Web 오퍼월 표시](#web-오퍼월-표시)

## 👤️ 개발자 등록
NAS 오퍼월 연동을 위해서는 먼저 개발자 등록을 해야합니다.

[NAS 홈페이지](http://www.appang.kr/nas) 에 접속하여 `회원가입` 버튼을 눌러 가입합니다.

## 🎲 매체 등록
NAS 오퍼월 연동을 위해서는 연동할 매체 등록 해야합니다.

[NAS 홈페이지](http://www.appang.kr/nas) 에 로그인 후 `신규매체 등록` 버튼을 눌러 매체를 등록합니다.

매체를 등록하면 32자리 `앱 KEY`가 발급되며, Web 오퍼월 노출 시 필요한 값입니다.
`매체 관리` 메뉴에서 등록한 매체의 우측 `more` 버튼을 눌러 `앱 KEY 복사` 를 눌러 `앱 KEY`를 복사할 수 있습니다.

### `적립금 관리 서버`
사용자 적립금을 NAS 서버에서 관리할지 아니면 개발자 서버에서 관리할지를 선택합니다.
Web 오퍼월을 사용하려면, `개발자 서버 사용`을 선택해야합니다.

- `개발자 서버 사용` : 개발자가 서버에서 사용자 적립금을 직접 관리할 경우 선택합니다. 사용자가 적립금 충전 시 개발자 서버의 콜백 URL로 통보해줍니다.

### `리워드 금액 단위`
리워드 금액 단위는 오퍼월 에서 사용자에게 보이는 리워드 금액의 단위입니다.

만약 광고 참여 완료 시 사용자에게 100골드를 준다면 `골드`를 입력하고, 100원을 준다면 `원`을 입력합니다

### `리워드 금액 비율`
리워드 금액 비율은 광고 참여 완료 시 개발자가 얻게되는 수익 중에서 사용자에게 리워드로 줄 금액의 비율(%)입니다.

만약 사용자가 광고참여 시 개발자가 받게되는 수익이 200원이고, 사용자에게 100원을 주고 싶으면 리워드 금액 비율을 `50`으로 입력합니다.

각 광고마다 개발자에게 지급되는 금액이 다르기 때문에, 사용자에게 지급하는 실제 금액은 `콜백 URL` 호출 시 함께 전송됩니다.

### `콜백 URL 등록`
`콜백 URL`은 NAS 서버에서 개발자 서버로 호출하는 URL로 사용자가 광고 `참여 완료` 시 호출됩니다. `콜백 URL`에서 사용자에게 적립금등의 혜택을 지급하도록 구성하시기 바랍니다.
콜백 URL은 `앱 설정` 화면의 `보상형 기본` 탭에서 설정할 수 있습니다.

`콜백 URL`에는 아래의 값들이 제공됩니다.

이 값들은 개발자 서버로 호출 시 실제 값으로 변환됩니다. `콜백 URL` 입력 시 반드시 `대괄호`까지 입력하시기 바랍니다.

- `[SEQ_ID]` : 적립 고유 ID
- `[USER_DATA]` : 회원 정의 데이터
- `[PRICE]` : 광고 단가 (매체 수익금)
- `[REWARD]` : 리워드 금액 (오퍼월에서 참여한 경우에만 값이 있음)
- `[AD_ID]` : 광고 ID
- `[AD_KEY]` : 광고 KEY
- `[AD_NAME]` : 광고명
- `[AD_TYPE]` : 광고구분 (CPI, CPE, CPA, CPC, FACEBOOK)
- `[USER_ADID]` : 사용자 기기 36자리 광고 ID (Android : ADID, iOS : IDFA)
- `[USER_IP]` : 사용자 IP 주소

```
http://server.kr/callback.asp?sid=[SEQ_ID]&ud=[USER_DATA]&p=[PRICE]&r=[REWARD]&ai=[AD_ID]&ak=[AD_KEY]&n=[AD_NAME]&t=[AD_TYPE]&adid=[USER_ADID]&ip=[USER_IP]`
```

개발자 서버의 웹페이지가 `HTTP 200` 상태값을 리턴하면 `콜백 URL`을 더 이상 호출하지 않고 중지됩니다.
만약 `HTTP 200` 이외의 상태값이 리턴되면 `최대 5번`까지 재시도하여 호출하고, `5번` 오류가 발생하면 더 이상 호출하지 않습니다.

오류 횟수에 따른 `재호출` 시간 간격은 아래와 같습니다.

- `1회 오류 시` : 오류 시점부터 5분 후 재호출
- `2회 오류 시` : 오류 시점부터 10분 후 재호출
- `3회 오류 시` : 오류 시점부터 25분 후 재호출
- `4회 오류 시` : 오류 시점부터 30분 후 재호출
- `5회 오류 시` : 오류 시점부터 8시간 후 재호출
- `6회 오류 시` : 호출 중단

> ***적립금 중복 지급 방지를 위한 처리***
> - 콜백 중복 호출 시, 적립금 중복 지급을 방지하기 위해, `[SEQ_ID]`를 기준으로 중복지급을 막아주시기 바랍니다.
>
> - 동일 사용자에게 적립금 중복 지급을 방지하기 위해, 개발사의 `회원 ID` 와 `[AD_ID]` 값을 기준으로 중복지급을 막아주시기 바랍니다.

## 🚀⠀Web 오퍼월 표시

- URL
  ```
  https://www.appang.kr/nas/ow/oww.asp
  ```

- 파라메터
  - ak : 매체 등록 후 발급 받은 32자리 앱 KEY
  - uid : 회원 고유 ID (매체에서 사용하는 회원의 고유 ID)
  - ud : 적립 콜백 URL 호출 시 받을 "회원 정의 데이터" 값 (매체에서 회원에게 리워드 지급 시 회원을 구분하기 위한 용도로 사용)
  - tm : 테스트 광고 노출 여부 (개발시에는 1 값을 넘기고, 배포시에는 tm 파라메터를 넘기지 않습니다)


- 예제 소스
```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <script>
      var appKey = ""; // 매체 등록 후 발급 받은 32자리 앱 KEY 입력
      var userId = ""; // 회원 고유 ID 입력
      var userData = ""; // 적립 콜백 URL 호출 시 받을 "회원 정의 데이터" 값 입력
      var testMode = true; // true 로 설정하면 테스트 광고가 노출됩니다. (개발시에는 true 로 설정하고, 배포시에는 false 로 설정)

      var params = "ak=" + appKey + "&uid=" + encodeURIComponent(userId) + "&ud=" + encodeURIComponent(userData);

      if (testMode) {
      params += "&tm=1";
    }

      function showOfferwall() {
      window.open("https://www.appang.kr/nas/ow/oww.asp?" + params, "NasWebOfferWall");
    }
    </script>
  </head>
  <body>
    <button onclick="showOfferwall()">오퍼월 표시</button>
  </body>
</html>

```
